<!DOCTYPE html>
<html lang="en">
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1">
   <title>利用Iptables对gost/socat/broo进行流量统计</title>
   <meta name="description" content="除了使用iptables来进行端口转发，很多人会使用各种软件来进行中转，例如gost，socat，brook。有的自带流量统计，有的没有，但都可以通过iptables实现流量统计，配合Grafana+Prometheus，可以做出好看的流量统计面板。">
   <meta name="keywords" content="Grafana, Promethus, V2ray, Iptables" />
   <meta name="HandheldFriendly" content="True">
   <meta name="robots" content="index,follow">
   <meta name="googlebot" content="index,follow">
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-119177383-3"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
gtag('config', 'UA-119177383-3');
</script>
	<meta property="og:title" content="利用Iptables对gost/socat/broo进行流量统计" />
	<meta property="og:type" content="article" />
<meta property="og:image" content="https://blog.leishi.io/assets/machu-picchu.jpg" />
<meta property="og:site_name" content="Lei Shi&#39;s Blog" />
<meta property="og:description" content="除了使用iptables来进行端口转发，很多人会使用各种软件来进行中转，例如gost，socat，brook。有的自带流量统计，有的没有，但都可以通过iptables实现流量统计，配合Grafana+Prometheus，可以做出好看的流量统计面板。" />
<meta property="og:url" content="https://blog.leishi.io/pages/readme/Monitoring-forwarded-traffic" />
	<meta property="article:author" content="https://leishi.io" />
	<link rel="author" href="https://leishi.io" />
<meta property="article:published_time" content="2020-08-13T20:00:00-07:00" />
<meta property="article:tag" content="Grafana" />
<meta property="article:tag" content="Promethus" />
<meta property="article:tag" content="V2ray" />
<meta property="article:tag" content="Iptables" />
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="利用Iptables对gost/socat/broo进行流量统计">
<meta name="twitter:url" content="https://blog.leishi.io/">
<meta name="twitter:description" content="除了使用iptables来进行端口转发，很多人会使用各种软件来进行中转，例如gost，socat，brook。有的自带流量统计，有的没有，但都可以通过iptables实现流量统计，配合Grafana+Prometheus，可以做出好看的流量统计面板。">
<meta name="twitter:image:src" content="https://blog.leishi.io/assets/machu-picchu.jpg">
  <link rel="stylesheet" href="https://blog.leishi.io/css/screen.css">
  <link rel="alternate" type="application/rss+xml" title="Lei Shi's Blog" href="https://blog.leishi.io/feed.xml">
  <link rel="icon" href="https://blog.leishi.io/assets/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="icon" href="https://blog.leishi.io/assets/favicon-32.png" sizes="32x32" type="image/png">
</head>
<body class="home-template">
   <div class="site-wrapper">
<header class="main-header detail-page image-bg  has-cover" style="background-image: url(https://blog.leishi.io/assets/machu-picchu.jpg)" >
    <!--
   <h1 class="page-title"><a href="https://blog.leishi.io/" title="Lei Shi's Blog">Lei Shi's Blog</a></h1>
   <h2 class="page-description">Example Blog</h2>
    -->
   <div class="nav">
            <a class="page-link" href="https://blog.leishi.io/" title="Home">Home</a>
            <a class="page-link" href="https://blog.leishi.io/offline-warning/" title="Offline">Offline</a>
            <a class="page-link" href="https://blog.leishi.io/about" title="About">About</a>
   </div>
</header>
       <main class="content" role="main">
   <article class="post single-post" itemscope itemtype="http://schema.org/BlogPosting">
      <header class="post-header short-diver">
           <h1 class="post-title" itemprop="name headline">利用Iptables对gost/socat/broo进行流量统计</h1>
           <section class="post-meta">
                <time datetime="2020-08-13T20:00:00-07:00" itemprop="datePublished">Aug 13, 2020</time>
           </section>
       </header>
       <section class="post-content short-diver" itemprop="articleBody">
           <p>除了使用iptables来进行端口转发，很多人会使用各种软件来进行中转，例如<a href="https://github.com/ginuerzh/gost">gost</a>，socat，<a href="https://github.com/txthinking/brook">brook</a>。有的自带流量统计，有的没有，但都可以通过iptables实现流量统计，配合<a href="https://blog.leishi.io/pages/readme/Making-A-Traffic-Panel-Using-Grafana-And-Promethus">Grafana+Prometheus</a>，可以做出好看的流量统计面板。</p>
<p><img src="https://blog.leishi.io/assets/2020-08-13/v2ray_iptables.png" alt="" /></p>
<h2 id="添加iptables规则">添加iptables规则</h2>
<p>首先查看下默认网卡的绑定的ip：</p><pre><code class="language-shell"># 查看默认网卡
ip route show | grep default | awk '{print $5}'
# 假设默认网卡为eth0，查看其绑定的ip
ip address show eth0 scope global |  awk '/inet / {split($2,var,"/"); print var[1]}'
</code></pre>
<p>假设中转的规则是<code>443-&gt;8.8.8.9:444</code>，假设默认网卡绑定的ip是<code>8.8.8.8</code>，添加如下两条规则就可以让iptables显示经过这条中转规则的流量：</p><pre><code class="language-shell">export INET=8.8.8.8
export LOCAL_PORT=443
export REMOTE_IP=8.8.8.9
export REMOTE_PORT=444
iptables -A INPUT -p tcp -d $INET --dport $LOCAL_PORT -m comment --comment "UPLOAD $LOCAL_PORT-&gt;$REMOTE_IP:$REMOTE_PORT"
iptables -A INPUT -p tcp -s $REMOTE_IP -d $INET -m comment --comment "DOWNLOAD $LOCAL_PORT-&gt;$REMOTE_IP:$REMOTE_PORT"
</code></pre>
<blockquote>
 <p>运行<code>iptables -nxvL</code>查看一下流量统计有没有起作用</p>
</blockquote>
<p>如果不想自己手写iptables规则，也可以用我写的<a href="https://raw.githubusercontent.com/LeiShi1313/net-traffic-exporter/master/iptables.sh">脚本</a>：</p><pre><code class="language-shell">bash iptables monitor LOCAL_PORT REMOTE_IP REMOTE_PORT
</code></pre>
<h2 id="grafanapromethus流量统计面板">Grafana+Promethus流量统计面板</h2>
<p>见<a href="https://blog.leishi.io/pages/readme/Making-A-Traffic-Panel-Using-Grafana-And-Promethus">前文</a>，如果已经全部搭好，应该已经可以看到经过的流量了。下面我分别用gost/socat/brook来试试看流量统计的效果。</p>
<h3 id="gost">gost</h3>
<p>首先我在<code>sj0.leishi.io</code>上搭建个<code>ws+tls</code>的v2ray节点，然后通过<code>la0.leishi.io</code>来中转：</p><pre><code class="language-shell">lei@la0:~$ gost -L tcp://:10003/sj0.leishi.io:443
</code></pre>
<p>添加流量统计的iptables规则，查看有没有生效：</p><pre><code class="language-shell">lei@la0:~$ bash iptables monitor 10003 193.160.32.136 443
lei@la0:~$ sudo iptables -nvxL
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
    pkts      bytes target     prot opt in     out     source               destination
       0        0            tcp  --  *      *       0.0.0.0/0            107.175.63.10        tcp dpt:10003 /* UPLOAD 10003-&gt;193.160.32.136:443 */
       0        0            tcp  --  *      *       193.160.32.136       107.175.63.10        tcp spt:443 /* DOWNLOAD 10003-&gt;193.160.32.136:443 */

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
    pkts      bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 0 packets, 0 bytes)
    pkts      bytes target     prot opt in     out     source               destination
</code></pre>
<p>测试v2ray是否能连接
<img src="https://blog.leishi.io/assets/2020-08-13/Screenshot_20200913_204332.jpg" alt="" /></p>
<p>测两次速看看统计的效果，<code>la0 download/upload</code>是iptables的流量，<code>sj0 download/upload</code>是v2ray自带的流量统计功能：
<img src="https://blog.leishi.io/assets/2020-08-13/la0_sj0_gost.png" alt="" /></p>
<h3 id="socat">socat</h3>
<p>再试试socat</p><pre><code class="language-shell">lei@la0:~$ socat TCP4-LISTEN:10003,reuseaddr,fork TCP4:193.160.32.136:443
</code></pre>
<p>同样测两次速看看：
<img src="https://blog.leishi.io/assets/2020-08-13/la0_sj0_socat.png" alt="" />
可以看到两端的流量统计基本符合</p>
<h3 id="brook">brook</h3>
<p>我们再试试看brook中转的流量统计：</p><pre><code class="language-shell">lei@la0:~$ brook relay -f :10003 -t sj0.leishi.io:443
</code></pre>
<blockquote>
 <p>注意，如果使用的是一键脚本，可能已经有添加iptables规则，删除即可</p>
</blockquote>
<p>测两次速，再看一眼流量统计：
<img src="https://blog.leishi.io/assets/2020-08-13/la0_sj0_brook.png" alt="" /></p>
<h2 id="总结">总结</h2>
<p>如上的iptables规则能很好地用来统计中转的流量，配合Grafana搭建的面板，能够实时地查看服务器上各个端口的流量情况。</p>
       </section>
       <footer class="post-footer">
           <div itemprop="author" itemscope itemtype="http://schema.org/Person">
</div>
       </footer>
   </article>
</main>
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
   <div class="pswp__bg"></div>
   <div class="pswp__scroll-wrap">
       <div class="pswp__container">
           <div class="pswp__item"></div>
           <div class="pswp__item"></div>
           <div class="pswp__item"></div>
       </div>
       <div class="pswp__ui pswp__ui--hidden">
           <div class="pswp__top-bar">
               <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
               <div class="pswp__preloader">
                   <div class="pswp__preloader__icn">
                       <div class="pswp__preloader__cut">
                           <div class="pswp__preloader__donut"></div>
                       </div>
                   </div>
               </div>
           </div>
           <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
               <div class="pswp__share-tooltip"></div>
           </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
           <div class="pswp__caption">
               <div class="pswp__caption__center"></div>
           </div>
       </div>
   </div>
</div>
<script type="text/javascript">
var config = {
  'disqus_shortname': 'blog'
};
</script>
<script src="https://blog.leishi.io/js/jquery-1.12.0.min.js"></script>
<script src="https://blog.leishi.io/js/jquery.fitvids.js"></script>
<script src="https://blog.leishi.io/js/prism.js"></script>
<script src="https://blog.leishi.io/js/photoswipe.js"></script>
<script src="https://blog.leishi.io/js/photoswipe-ui-default.js"></script>
<script src="https://blog.leishi.io/js/post.js"></script>
       <footer class="site-footer">
    <button class="go-to-top"></button>
   <p class="copyright"><a href="https://blog.leishi.io/" title="Lei Shi's Blog">Lei Shi's Blog</a> &copy; 2020 | <a href="https://blog.leishi.io/feed.xml" title="RSS Feed">RSS Feed</a></p>
   <p class="poweredby">powered by <a href="https://jekyllrb.com/" title="Jekyll">Jekyll</a> with the <a href="https://github.com/jwillmer/jekyllDecent" title="jekyllDecent Theme">jekyllDecent</a> theme</p>
</footer>
   </div>
</body>
<script src="https://blog.leishi.io/js/global.js"></script>
</html>
